<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read & Highlight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Style for highlighted text */
        .highlight {
            background-color: #fef08a;
            /* yellow-200 */
            cursor: pointer;
            position: relative;
        }

        /* Simple tooltip for the highlight popup */
        #highlight-tooltip {
            position: absolute;
            display: none;
            padding: 8px 12px;
            background-color: #1f2937;
            /* gray-800 */
            color: white;
            border-radius: 6px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar for saved articles -->
        <aside class="w-1/3 max-w-sm bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900">Read & Highlight</h1>
                <p class="text-sm text-gray-500 mt-1">Your saved articles. Synced everywhere.</p>
                <div id="user-info" class="mt-3 text-xs text-gray-400 break-all">Connecting...</div>
            </div>
            <div id="saved-articles-list" class="flex-grow overflow-y-auto p-2">
                <!-- Saved articles will be dynamically inserted here -->
                <div id="loader-sidebar" class="p-4 text-center text-gray-500">Loading articles...</div>
            </div>
        </aside>

        <!-- Main content area -->
        <main class="flex-grow flex flex-col bg-gray-50">
            <!-- URL Input Form -->
            <div class="p-4 border-b border-gray-200 bg-white shadow-sm">
                <form id="url-form" class="flex gap-2">
                    <input type="url" id="article-url" placeholder="Paste an article link here..."
                        class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        required>
                    <button type="submit"
                        class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow">Fetch
                        Article</button>
                </form>
            </div>

            <!-- Article Reading Pane -->
            <div id="article-view" class="flex-grow overflow-y-auto p-8 md:p-12 lg:p-16">
                <div id="article-content-wrapper" class="max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-lg shadow-lg">
                    <div id="placeholder" class="text-center text-gray-500">
                        <h2 class="text-2xl font-semibold mb-2">Welcome!</h2>
                        <p>Paste a link above to start reading, or select a saved article from the sidebar.</p>
                    </div>
                    <div id="loader-main" class="hidden text-center text-gray-500">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p>Fetching and cleaning article...</p>
                    </div>
                    <article id="article-content" class="prose lg:prose-xl max-w-none"></article>
                </div>
            </div>
        </main>
    </div>

    <!-- Tooltip for highlighting -->
    <div id="highlight-tooltip">
        <button id="highlight-button"
            class="bg-yellow-300 text-yellow-900 font-bold py-1 px-3 rounded">Highlight</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // These global variables are provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-read-highlight-app';
        const firebaseConfig = {
            apiKey: "AIzaSyBD9Q-GgmHv2K3DaNGXAGMQANH59SGGpog",
            authDomain: "reader-highlighter.firebaseapp.com",
            projectId: "reader-highlighter",
            storageBucket: "reader-highlighter.firebasestorage.app",
            messagingSenderId: "515869894530",
            appId: "1:515869894530:web:22f3a4adeb3c7a44e8919b",
            measurementId: "G-QFW13VXR74"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, articlesCollectionRef;
        let currentArticleId = null;

        // --- UI Element References ---
        const urlForm = document.getElementById('url-form');
        const articleUrlInput = document.getElementById('article-url');
        const articleView = document.getElementById('article-view');
        const articleContent = document.getElementById('article-content');
        const placeholder = document.getElementById('placeholder');
        const loaderMain = document.getElementById('loader-main');
        const loaderSidebar = document.getElementById('loader-sidebar');
        const savedArticlesList = document.getElementById('saved-articles-list');
        const userInfo = document.getElementById('user-info');
        const highlightTooltip = document.getElementById('highlight-tooltip');
        const highlightButton = document.getElementById('highlight-button');

        // --- Core Application Logic ---

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfo.textContent = `User ID: ${userId}`;
                        setupFirestoreListeners();
                    } else {
                        // If no user, sign in.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userInfo.textContent = "Error: Could not connect to the service.";
            }
        }

        /**
         * Sets up real-time listeners for Firestore data.
         */
        function setupFirestoreListeners() {
            articlesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/articles`);
            const q = query(articlesCollectionRef);

            onSnapshot(q, (snapshot) => {
                loaderSidebar.style.display = 'none';
                const articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort articles by creation date, newest first
                articles.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                savedArticlesList.innerHTML = ''; // Clear existing list
                if (articles.length === 0) {
                    savedArticlesList.innerHTML = '<p class="p-4 text-sm text-gray-400">No articles saved yet.</p>';
                    return;
                }
                articles.forEach(article => {
                    const articleEl = document.createElement('div');
                    articleEl.className = `p-3 m-1 rounded-lg cursor-pointer border-2 flex justify-between items-center ${article.id === currentArticleId ? 'bg-blue-100 border-blue-500' : 'bg-white border-transparent hover:bg-gray-100'}`;
                    articleEl.dataset.id = article.id;

                    const textContainer = document.createElement('div');
                    textContainer.className = 'flex-grow overflow-hidden'; // Added overflow-hidden
                    textContainer.innerHTML = `
                        <h3 class="font-semibold text-gray-800 truncate">${article.title || 'Untitled Article'}</h3>
                        <p class="text-xs text-gray-500 truncate">${article.url}</p>
                    `;
                    textContainer.addEventListener('click', () => loadArticle(article.id));

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&#x2715;'; // Cross symbol
                    deleteBtn.className = 'ml-2 text-red-400 hover:text-red-600 font-bold px-2 flex-shrink-0'; // Added flex-shrink-0
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteArticle(article.id);
                    };

                    articleEl.appendChild(textContainer);
                    articleEl.appendChild(deleteBtn);
                    savedArticlesList.appendChild(articleEl);
                });
            }, (error) => {
                console.error("Error fetching articles:", error);
                savedArticlesList.innerHTML = '<p class="p-4 text-sm text-red-500">Could not load articles.</p>';
            });
        }

        /**
         * Fetches and displays a saved article from Firestore.
         * @param {string} docId - The Firestore document ID of the article.
         */
        async function loadArticle(docId) {
            try {
                currentArticleId = docId;
                updateSidebarSelection();
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/articles`, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const article = docSnap.data();
                    placeholder.style.display = 'none';
                    loaderMain.style.display = 'none';
                    articleContent.innerHTML = article.content;
                    document.querySelector('#article-content-wrapper').style.display = 'block';
                } else {
                    console.log("No such document!");
                    currentArticleId = null;
                    articleContent.innerHTML = '';
                    placeholder.style.display = 'block';
                }
            } catch (error) {
                console.error("Error loading article:", error);
            }
        }

        /**
         * Deletes an article from Firestore.
         * @param {string} docId - The Firestore document ID of the article to delete.
         */
        async function deleteArticle(docId) {
            // A custom modal would be better than confirm, but for simplicity:
            if (!confirm('Are you sure you want to delete this article?')) {
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/articles`, docId);
                await deleteDoc(docRef);

                // If the deleted article was the one being viewed, clear the view
                if (currentArticleId === docId) {
                    currentArticleId = null;
                    articleContent.innerHTML = '';
                    placeholder.style.display = 'block';
                }
            } catch (error) {
                console.error("Error deleting article:", error);
            }
        }

        /**
         * Updates the visual selection in the sidebar.
         */
        function updateSidebarSelection() {
            const items = savedArticlesList.querySelectorAll('div[data-id]');
            items.forEach(item => {
                if (item.dataset.id === currentArticleId) {
                    item.classList.add('bg-blue-100', 'border-blue-500');
                    item.classList.remove('bg-white', 'border-transparent', 'hover:bg-gray-100');
                } else {
                    item.classList.remove('bg-blue-100', 'border-blue-500');
                    item.classList.add('bg-white', 'border-transparent', 'hover:bg-gray-100');
                }
            });
        }

        /**
         * Handles the URL form submission.
         */
        urlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = articleUrlInput.value.trim();
            if (!url) return;

            placeholder.style.display = 'none';
            articleContent.innerHTML = '';
            loaderMain.style.display = 'block';
            document.querySelector('#article-content-wrapper').style.display = 'block';

            try {
                // Using a different CORS proxy to fetch URL content
                const response = await fetch(`https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok.');

                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Simple heuristic to find the main content
                let mainContent = doc.querySelector('article, [role="main"], #main, .main, #content, .content');
                if (!mainContent) {
                    mainContent = doc.body; // Fallback to body
                }

                // Remove scripts, styles, and other non-essential tags
                mainContent.querySelectorAll('script, style, link, nav, header, footer, aside, iframe, form, noscript').forEach(el => el.remove());

                const title = doc.querySelector('h1')?.textContent || doc.title || 'Untitled Article';

                // Save to Firestore
                const newArticleRef = await addDoc(articlesCollectionRef, {
                    url: url,
                    title: title,
                    content: mainContent.innerHTML,
                    highlights: [],
                    createdAt: serverTimestamp()
                });

                currentArticleId = newArticleRef.id;
                loadArticle(currentArticleId);

            } catch (error) {
                console.error("Failed to fetch or parse article:", error);
                articleContent.innerHTML = `<p class="text-red-500">Sorry, we couldn't fetch that article. The proxy service may be down or the target website could be blocking it. Please try a different link.</p>`;
            } finally {
                loaderMain.style.display = 'none';
                urlForm.reset();
            }
        });

        // --- Highlighting Logic ---

        let currentSelection = null;

        /**
         * Shows the highlight tooltip when text is selected.
         */
        articleContent.addEventListener('mouseup', (e) => {
            // Don't show tooltip if we're clicking on an existing highlight to remove it
            if (e.target.classList.contains('highlight')) {
                return;
            }
            const selection = window.getSelection();
            if (selection.toString().trim().length > 0) {
                currentSelection = selection.getRangeAt(0);
                const rect = currentSelection.getBoundingClientRect();

                highlightTooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - highlightTooltip.offsetWidth / 2}px`;
                highlightTooltip.style.top = `${rect.top + window.scrollY - highlightTooltip.offsetHeight - 5}px`;
                highlightTooltip.style.display = 'block';
            } else {
                highlightTooltip.style.display = 'none';
            }
        });

        /**
        * Hides the tooltip when clicking elsewhere.
        */
        document.addEventListener('mousedown', (e) => {
            if (!highlightTooltip.contains(e.target) && highlightTooltip.style.display === 'block') {
                highlightTooltip.style.display = 'none';
            }
        });

        /**
         * Handles the click on the "Highlight" button.
         */
        highlightButton.addEventListener('click', async () => {
            if (currentSelection && currentArticleId) {
                const highlightId = `highlight-${Date.now()}`;
                const mark = document.createElement('mark');
                mark.className = 'highlight';
                mark.id = highlightId;

                try {
                    mark.appendChild(currentSelection.extractContents());
                    currentSelection.insertNode(mark);
                    await saveHighlights();

                } catch (error) {
                    console.error("Could not create highlight. The selected text might span across multiple HTML blocks.", error);
                    window.getSelection().addRange(currentSelection);
                }
            }
            highlightTooltip.style.display = 'none';
            window.getSelection().removeAllRanges();
        });

        /**
         * Handles clicking on an existing highlight to remove it.
         */
        articleContent.addEventListener('click', async (e) => {
            if (e.target.classList.contains('highlight')) {
                if (confirm('Remove this highlight?')) {
                    const highlightElement = e.target;
                    const parent = highlightElement.parentNode;
                    // Move all children of the <mark> tag out into the parent
                    while (highlightElement.firstChild) {
                        parent.insertBefore(highlightElement.firstChild, highlightElement);
                    }
                    // Remove the now-empty <mark> tag
                    parent.removeChild(highlightElement);
                    await saveHighlights();
                }
            }
        });


        /**
         * Saves the current state of highlights and content to Firestore.
         */
        async function saveHighlights() {
            if (!currentArticleId) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/articles`, currentArticleId);

                const highlights = [];
                articleContent.querySelectorAll('.highlight').forEach(h => {
                    highlights.push({
                        id: h.id,
                        text: h.textContent,
                    });
                });

                await updateDoc(docRef, {
                    highlights: highlights,
                    content: articleContent.innerHTML
                });
            } catch (error) {
                console.error("Error saving highlights:", error);
            }
        }

        // --- Initial Load ---
        initializeFirebase();

    </script>
</body>

</html>